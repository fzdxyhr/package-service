<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ADS打包平台</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <script src="js/jquery-3.2.1.min.js" type="text/javascript"></script>
    <script src="js/bootstrap.min.js" type="text/javascript"></script>
    <script src="js/vue.min.js"></script>
    <style>
        body {
            color: white;
            background: url("image/back.jpg") repeat-y center top;
        }

        .input_class {
            background-color: rgba(16, 27, 29, 0.5);
            color: white;
            border-color: rgba(16, 27, 29, 0.5);
        }
    </style>
</head>
<body>
<!--<div style="position:absolute; width:100%; height:100%; z-index:-1">-->
<!--<img src="image/back.jpg" height="100%" width="100%"/>-->
<!--</div>-->
<div align="center" style="margin-bottom: 2%;margin-top: 5px;">
    <h2>ADS打包列表</h2>
</div>

<div id="main" style="margin-left: 10px;margin-right: 10px;">
    <div style="margin-bottom: 2%;margin-top: 5px;">
        <button type="button" class="btn btn-default" @click="queryByNow">立即刷新</button>
        <button type="button" class="btn btn-default" @click="queryByTimeTask" style="margin-left: 10px;">定时刷新</button>
        <button type="button" class="btn btn-default" @click="closeTimeTask" style="margin-left: 10px;">关闭定时刷新</button>
    </div>
    <ul id="myTab" class="nav nav-tabs">
        <li class="active"><a href="#install" data-toggle="tab">安装包列表</a></li>
        <li><a href="#upgrade" data-toggle="tab">升级包列表</a></li>

    </ul>
    <div id="myTabContent" class="tab-content">
        <div class="tab-pane fade in active" id="install">
            <table class="table table-striped">
                <thead v-show="install_items.length > 0">
                <tr>
                    <th>安装包名称</th>
                    <th>安装包路径</th>
                    <th>安装包大小</th>
                    <th>创建时间</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody v-for="install in install_items" v-show="install_items.length > 0">
                <tr style="background-color: rgba(8, 21, 29, 0.7);">
                    <td>{{install.file_name}}</td>
                    <td>{{install.file_path}}</td>
                    <td>{{install.file_size}}MB</td>
                    <td>{{install.file_date}}</td>
                    <td><a href="javascript:void(0)" @click="downloadFile(install.file_path)">下载</a></td>
                </tr>
                </tbody>
            </table>
            <div v-show="install_items.length == 0">
                <div align="center" style="margin-top: 10%;">暂无数据</div>
            </div>
        </div>
        <div class="tab-pane fade" id="upgrade">
            <table class="table table-striped" id="upgrade_table">
                <thead v-show="upgrade_items.length > 0">
                <tr>
                    <th>升级包名称</th>
                    <th>升级包路径</th>
                    <th>升级包大小</th>
                    <th>创建时间</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody v-for="upgrade in upgrade_items" v-show="upgrade_items.length > 0">
                <tr style="background-color: rgba(8, 21, 29, 0.7);">
                    <td>{{upgrade.file_name}}</td>
                    <td>{{upgrade.file_path}}</td>
                    <td>{{upgrade.file_size}}MB</td>
                    <td>{{upgrade.file_date}}</td>
                    <td><a href="javascript:void(0)" @click="downloadFile(install.file_path)">下载</a></td>
                </tr>
                </tbody>
            </table>
            <div v-show="upgrade_items.length == 0">
                <div align="center" style="margin-top: 10%;">暂无数据</div>
            </div>
            <div style="float: right;">
                <ul class="pagination">
                    <li><a href="#">上一页</a></li>
                    <li><a href="#" v-for="index in pagesSize">{{ index }}</a></li>
                    <li><a href="#">下一页</a></li>
                </ul>
            </div>
        </div>
    </div>
    <!-- 模态框（Modal） -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" style="background-color: rgba(8, 21, 28, 0.6);">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="myModalLabel">提示</h4>
                </div>
                <div class="modal-body">{{ content }}</div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>
</div>
<script>
    $(function () {
        $('#myTab li:eq(0) a').tab('show');
//        $('#upgrade_table').bootstrapTable({
//            //请求方法
//            method: 'get',
//            //是否显示行间隔色
//            striped: true,
//            //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
//            cache: false,
//            //是否显示分页（*）
//            pagination: true,
//            //是否启用排序
//            sortable: false,
//            //排序方式
//            sortOrder: "asc",
//            //初始化加载第一页，默认第一页
//            //我设置了这一项，但是貌似没起作用，而且我这默认是0,- -
//            //pageNumber:1,
//            //每页的记录行数（*）
//            pageSize: 10,
//            //可供选择的每页的行数（*）
//            pageList: [10, 25, 50, 100],
//            //这个接口需要处理bootstrap table传递的固定参数,并返回特定格式的json数据
//            url: "/test/testtable.action",
//            //默认值为 'limit',传给服务端的参数为：limit, offset, search, sort, order Else
//            //queryParamsType:'',
//            ////查询参数,每次调用是会带上这个参数，可自定义
//            queryParams : function(params) {
//                var subcompany = $('#subcompany option:selected').val();
//                var name = $('#name').val();
//                return {
//                    pageNumber: params.offset+1,
//                    pageSize: params.limit,
//                    companyId:subcompany,
//                    name:name
//                };
//            },
//            //分页方式：client客户端分页，server服务端分页（*）
//            sidePagination: "server",
//            //Indicate which field is an identity field.
//            idField : "id",
//            columns: [{
//            field: 'id',
//            title: 'id',
//            align: 'center'
//            }, {
//                field: 'testkey',
//                title: '测试标识',
//                align: 'center'
//            }, {
//                field: 'testname',
//                title: '测试名字',
//                align: 'center'
//            },{
//                field: 'id',
//                title: '操作',
//                align: 'center',
//                formatter:function(value,row,index){
//                    //通过formatter可以自定义列显示的内容
//                    //value：当前field的值，即id
//                    //row：当前行的数据
//                    var a = '<a href="" >测试</a>';
//                }
//            }],
//            pagination:true
//        });
    });
    var vue = new Vue({
        el: '#main',
        data: {
            page_no:1,
            page_size:2,
            total:0,
            pagesSize:1,
            svn_url:"",
//            build:"",
            version:"",
            packageType:1,
            content:"",
            queryLogJobId: 0,
            queryInstallJobId: 0,
            queryUpgradeJobId: 0,
            queryResultJobId:0,
            startPackageDisable: false,
            log_content: "",
            status: false,
            upgrade_items: [],
            install_items: [],
            resultObj:{}
        },
        computed:{
            build : function(){
                let date = new Date();
                return this.formatDate(date,"yyyyMMdd");
            }
        },
        methods: {
            queryByNow: function () {
                let self = this;
                self.queryInstallPackage();
                self.queryUpgradePackage();
            },
            queryByTimeTask:function(){
                let self = this;
                self.queryInstallPackageByTime();
                self.queryUpgradePackageByTime();
                self.content = "定时刷新启动成功";
                $('#myModal').modal('show');
            },
            closeTimeTask:function(){
                let self = this;
                window.clearInterval(self.queryInstallJobId);
                window.clearInterval(self.queryUpgradeJobId);
                self.content = "定时刷新关闭成功";
                $('#myModal').modal('show');
            },
            queryInstallPackage: function () {
                let self = this;
                $.ajax({
                    type: "GET",
                    url: "/v1/files/1",
                    success: function (data) {
                        self.install_items = data;
                    },
                    error: function (error) {
                        console.log(error);
                    }
                });
            },
            queryUpgradePackage: function () {
                let self = this;
                $.ajax({
                    type: "GET",
                    url: "/v1/files/2",
                    success: function (data) {
//                        var message = $.parseJSON(data);//后台返回的json数据需要转为对象
                        self.upgrade_items = data;
//                        console.log(self.upgrade_items.length)
                        self.total = self.upgrade_items.length;
                        if(parseInt(self.total) % parseInt(self.page_size) == 0) {
                            self.pagesSize = parseInt(parseInt(self.total) / parseInt(self.page_size));
                        } else {
                            self.pagesSize = parseInt(parseInt(self.total) / parseInt(self.page_size)) +1;
                        }
                    },
                    error: function (error) {
                        console.log(error);
                    }
                });
            },
            queryInstallPackageByTime: function () {
                let self = this;
                self.queryInstallJobId = window.setInterval(function(){
                    self.queryInstallPackage();
                },10000);
            },
            queryUpgradePackageByTime: function () {
                let self = this;
                self.queryUpgradeJobId = window.setInterval(function () {
                    self.queryUpgradePackage();
                },10000);
            },
            downloadFile: function (path) {
                window.location = "/v1/files/download?path=" + path;
            },
            isUrl:function(str_url){
                var urlRegExp=/^((https|http|ftp|rtsp|mms)?:\/\/)+[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\':+!]*([^<>\"\"])*$/;
                if (urlRegExp.test(str_url)) {
                    return true;
                } else {
                    return false;
                }
            },
            formatDate:function(date, fmt){
                let self = this;
                if (/(y+)/.test(fmt)) {
                    fmt = fmt.replace(RegExp.$1, (date.getFullYear() + '').substr(4 - RegExp.$1.length));
                }
                let o = {
                    'M+': date.getMonth() + 1,
                    'd+': date.getDate(),
                    'h+': date.getHours(),
                    'm+': date.getMinutes(),
                    's+': date.getSeconds()
                };
                for (let k in o) {
                    if (new RegExp(`(${k})`).test(fmt)) {
                        let str = o[k] + '';
                        fmt = fmt.replace(RegExp.$1, (RegExp.$1.length === 1) ? str : self.padLeftZero(str));
                    }
                }
                return fmt;
            },
            padLeftZero:function(str){
                return ('00' + str).substr(str.length);
            }
        }
    });
</script>
</body>
</html>